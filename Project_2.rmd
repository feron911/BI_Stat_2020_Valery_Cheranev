---
title: "The_most_expensive_house"
output: html_document
---
### Блок для установки 
    Этот раздел включает функцию для установки (или включения) библиотек для работы отчёта.
```{r setup, message=FALSE, warning=FALSE, collapse=TRUE}
# Список используемых библиотек (для дальнейшей работы с отчётом: "car", "MASS", "ggplot2","markdown","GGally", "psych", "Hmisc", "dplyr", "lmtest", "ggpubr".
# Функция для установки библиотек используемых в отчёте (при необходимости). Не требует аргументов.
setup_libs <- function() {
  libs <- c("car", "MASS", "ggplot2","markdown","GGally", "psych", "Hmisc", "dplyr", "lmtest", "ggpubr")
for (i in 1:length(libs)){
  if (!require(libs[i], character.only = T)) install.packages(libs[i])
  library(libs[i], character.only = T)
}
}
setup_libs()
```

## EDA и стандартизация данных
    Вызвав справку для предложенных данных (help("Boston")), можно сказать, что в датафрейме содержится \n 14 переменных. Две из них записаны в формате "int" остальные "num".
```{r}
# help("Boston")
str(Boston)
Bos <- Boston
```
    
    Проверяем распределение и разброс переменных в составе датафрейма при помощи гистограмм.
```{r, fig.dim = c(10, 7)} 
multi.hist(Bos)
```

    Как видно из гистограмм выше, большинство переменных распределены не нормально. Это может повлять на качество \n построенной модели. Для оптимизации модели возможно будет необходима трансформация некоторых переменных.
    Переменная "chas" является "dummy variable", но записана в качестве num. Переменная показывает наличие реки рядом с участком (1 - река рядом, 0 - реки рядом нет). Переменная "rad" также является факторной и имеет 9 уровней. Эта переменная отражает доступность радиальных дорог, ведущих к центру городской агломерации и обратно для участка (чем выше значение переменной, тем доступнее дорога). Обе переменные для корректного дальнейшего анализа необходимо привести к фактору. Остальные переменные хоть и отражены в разных единицах измерения (проценты, средние значения и т.д.) ввиду достаточного разброса наблюдений могут быть стандартизованы и использованы для построения линейной регресии. Результаты преобразований записаны в переменную "Scaled_Bos".
```{r, }
unique(Bos$chas)
Bos$chas <- factor(Bos$chas, levels = c(1,0), labels = c("River_close", "River_far"))
```
```{r, fig.dim = c(10,10)}
unique(Bos$rad)
Bos$rad <- factor(Bos$rad, levels = unique(Bos$rad), labels = unique(Bos$rad))
Scaled_Bos <- as.data.frame(scale(Bos[,c(1:3,5:8,10:14)]))
Scaled_Bos$chas <- Bos$chas
Scaled_Bos$rad <- Bos$rad
str(Scaled_Bos)
boxplot(Scaled_Bos[,1:12])
```
    
    Боксплот показывает, что дисперсия между переменными значительно отличается, что также может оказать эффект на качество модели.
## Полная линейная модель со всеми предикторами без учета взаимодействия между ними 
    Построение и описание полной линейной модели без взаимодействия предикторов
```{r}
most_exp_house <- lm(medv ~ .+., Scaled_Bos)
summary(most_exp_house)
```
## Диагностика модели
### Проверка линейности взаимосвязи
    Для оценки линейности взаимосвязи строим Scatter plot для всех пар взаимодействий предикторов (за исключением факторных переменных).
```{r, fig.dim=c(15,15), message=F, echo=F}
ggpairs(select(Bos, -c(chas, rad)))
```

    Из графиков видно, что большая часть предикторов (кроме "rm") имеют не линейной взаимосвязи с зависимой переменной.  
### Проверка влиятельных наблюдений
```{r}
qqPlot(most_exp_house$residuals)
```
### Независимость наблюдений
```{r, fig.dim=c(10,10)}
cor.plot(Scaled_Bos[,1:12])
```
    
    Из графика с коэфициентами корреляция для всех количественных переменных видно, что некоторые переменные довольно сильно друг с другом взаимосвязаны (например, "nox" и "indus"), что свидетельствует о наличии в модели мультиколлинеарности.
### Нормальность распределения и постоянство дисперсии
```{r, echo=FALSE}
ggplot(most_exp_house, aes(x = most_exp_house$fitted.values, y = most_exp_house$residuals))+
  geom_point()
```
    
    График QQplot для остатков показывает, что среди остатков для построенной модели присутствуют выбросы, которые могу значительно влиять на значение оценки нормальности распределения при помощи параметрических тестов (Шапиро-Уилка тест, Т-тест и так далее). Поэтому можно воспользоваться непараметрическим аналогом критерием Манна-Уитни для проверки на нормальность распределения.
```{r}
wilcox.test(most_exp_house$residuals)
```

## График предсказаний стоимости от переменной "lstat"
```{r, result = "hide", echo = FALSE, warning=FALSE}
ggplot(most_exp_house, aes(x = most_exp_house$model$lstat, y = most_exp_house$fitted.values))+
  geom_point()+
  geom_smooth(method = "lm")+
  scale_x_continuous(name = "lstat")+
  scale_y_continuous(name = "fitted_values")+
  ggtitle("График зависимости предсказанных значений \n от предиктора с наибольшим влиянием (\"lstat\")")+
  theme(plot.title = element_text(hjust = 0.5))
  
```


## Качество модели
    
    Хоть модель и объясняет почти 75 процентов изменчивости переменной "medv", но вместе с тем при её построении были нарушены все требования необходимые для корректного построения линейной регресии. Большая чать предикторов не связаны в зависимой переменной линейно, остатки распределены не нормально и обладают гетероскедастичностью.
    Необходима дальнейшая доработка модели.

## Дополнительная часть - оптимизация модели

    Основным способом для удовлетворения всех требований для корректной линейной регрессии необходимо провести трансформацию переменных.
    
### Трансформация переменных похожих на факторные
```{r}
p1 <- ggplot(Boston, aes(x = tax, y = medv))+
  geom_point()
p2 <- ggplot(Boston, aes(x = rad, y = medv))+
  geom_point()
ggarrange(p1, p2, ncol = 2)
cor.test(Boston$rad, Boston$tax)
```
    Переменная, описывающая налоговую нагрузку, и переменная, описывающая доступность радиальных шоссе сильно коррелируют друг с другом, а так же при оценке их распределения распадаеются на две группы ("low_tax" vs "high_tax; "24rad" vs "lowrad"). 
```{r}
Bos$taxes <- ifelse(Bos$tax > 600, "High_tax", "Low_tax")
Bos$taxes <- as.factor(Bos$taxes)
Bos$radind <- ifelse(Bos$rad == 24, "24rad", "lowrad")
Bos$radind <- as.factor(Bos$radind)
```
### Трансформация переменных с ненормальным распределением
```{r}
multi.hist(Bos[,c(1:3, 5, 7, 8, 11:14)])
Bos_log <- as_tibble(mutate_all(Bos[,c(1:3, 5, 7, 8, 11:14)], function(.) ifelse(. != 0, log(.), .)))
multi.hist(Bos_log)
Bos_log <- as_tibble(mutate_all(Bos[,c("crim", "nox", "dis", "lstat", "medv")], function(.) ifelse(. != 0, log(.), .)))
Bos_log <- as_tibble(Bos_log, Bos[,c("crim", "nox", "dis", "lstat", "medv")])
```

    
```{r}
adj_most_exp_house <- step(most_exp_house)
summary(adj_most_exp_house)
ggplot(adj_most_exp_house, aes(x = most_exp_house$fitted.values, y = most_exp_house$residuals))+
  geom_point()
```



